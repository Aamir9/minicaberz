 @model IEnumerable<thechauffeurteam.Models.job>
@{
                /**/

                ViewBag.Title = "Admin";
                Layout = "~/Views/Shared/_AdminLayout.cshtml";
}
<!-- Header -->


@Html.Partial("~/Views/Admin/_header.cshtml")


<div class="container-fluid mt--7">

    <!-- Table -->
    <div class="row">
        <div class="col">
            <div class="card shadow">
                <div class="card-header border-0">
                    <h3 class="mb-0">Active Jobs</h3>
                </div>
                <div class="table-responsive" style="height:300px">
                    <table class="table align-items-center table-flush">
                        <thead class="" style="background:#1853a1; ">
                            <tr class="text-light px-1">
                                @*<th scope="col" class="text-light px-1 ml-0 px-0 text-center">Status</th>*@
                                <th scope="col" class="text-light px-0 mx-0 text-center">Time</th>
                                <th scope="col" class="text-light px-0 text-center">Pick Up</th>
                                <th scope="col" class="text-light px-0 text-center">Drop Off</th>
                                <th scope="col" class="text-light px-0 text-center">Miles</th>
                                <th scope="col" class="text-light px-0 text-center">Price</th>
                                <th scope="col" class="text-light px-0 text-center">Phone</th>
                                <th scope="col" class="text-light px-0 text-center">Name</th>
                                <th scope="col" class="text-light px-0 text-center">Cab Office</th>

                                <th class=" px-0"></th>
                            </tr>
                        </thead>

                        <tbody class="">

                            @foreach (var value in Model)
                            {


                                <tr class=" px-1" style="">



                                    <td scope="col" class="py-1 my-0 pr-0 mr-0" style="overflow:hidden;max-width:155px">@value.dateAndTime</td>
                                    <td scope="col" class="py-1 my-0 ml-0 px-0 " style="overflow:hidden;max-width:200px">@value.pickUp</td>
                                    <td scope="col" class="py-1 my-0 pr-0 ml-1" style="overflow:hidden;max-width:200px">@value.DropUP</td>
                                    <td scope="col" class="py-1 my-0 px-0 text-center">@value.Mile</td>
                                    <td scope="col" class="py-1 my-0 px-0 text-center">£&nbsp; @value.Price</td>
                                    <td scope="col" class="py-1 my-0 px-0 text-center">@value.PassengerPhone</td>
                                    <td scope="col" class="py-1 my-0 px-0 text-center">@value.PassengerName</td>
                                    <td scope="col" class="py-1 my-0 px-0 text-center">@value.DriverName</td>
                                    <td class="text-right py-1 my-0 px-0">
                                        <div class="dropdown">
                                            <a class="btn btn-sm btn-icon-only text-light" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="fas fa-ellipsis-v"></i></a>
                                            <div class="dropdown-menu dropdown-menu-right dropdown-menu-arrow">
                                                @{
                                                    var id = @value.id;
                                                }
                                                <a class="dropdown-item" href="" onclick="jobInfo(@id)" data-toggle="modal" data-target="#jobModal">Info</a>
                                                <a class="dropdown-item" href="" onclick="setfinshJobId(@id)" data-toggle="modal" data-target="#finishConfr">Finish</a>

                                                <a class="dropdown-item" href="" onclick="setCancelJobId(@id)" data-toggle="modal" data-target="#cancelConfr">Cancel</a>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>




    <div onload="ModalLoad()" class="modal fade" id="cancelConfr" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-notify" role="document" style="width:1000px">
            <div class="modal-content">
                <div class="modal-header bgred">
                    <h5 class="modal-title text-white">Alert</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body rd">
                    Do you realy want to cancel this Job?
                    <input type="hidden" id="cancelJobId" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary bgblue" data-dismiss="modal">No</button>
                    <button type="button" class="btn bgred" onclick="cancelJob()" data-dismiss="modal">Yes</button>
                </div>
            </div>
        </div>
    </div>







    @Html.Partial("_JobModalinfo")


    <!-- Footer -->
    @Html.Partial("~/Views/Shared/_CabAndAdminFooter.cshtml")
</div>




<div class="modal fade" id="finishConfr" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger"><b>Alert</b></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Is this job finished?
                <input type="hidden" id="finishJobId" value="">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
                <button type="button" class="btn btn-primary" onclick="finishJob()" data-dismiss="modal">Yes</button>
            </div>
        </div>
    </div>
</div>


@section scripts{
    <script type="text/javascript">


        function jobInfo(Id) {
            //alert("success" + Id)

             $.ajax({
                type: "POST",
                 url: '@Url.Action("JobInfo", "Admin")',
                 data: { id: Id },
                 dataType: "json",

                 success: function (success) {

                         //alert('pick Up :'+success.pickUp);
                         var txt = $("#jobId").val();
                         $("#jobId").html(txt + success.jb.id);
                         $("#jid").val(success.jb.id);
                         $("#pickUpAddress").val(success.jb.pickUp);
                         $("#dropOffAddress").val(success.jb.DropUP);
                         $("#distance").val(success.jb.Mile);
                         $("#price").val(success.jb.Price);
                         $("#carType").val(success.jb.CarType);

                         var dAndT = "" + success.jb.dateAndTime;

                         $("#time").val(dAndT.substring(0, 10).trim());
                         $("#date").val(dAndT.substring(10).trim());
                         $("#driverMessage").val(success.jb.DriverMessage);
                         $("#drvId").val(success.jb.DriverName);
                       //alert(success.jb.DriverId);
                         $("#name").val(success.jb.PassengerName);
                         $("#phone").val(success.jb.PassengerPhone);

                         console.log(success);
                 },
                 error: function (e, text, string) {
                    alert(e.message + text + string);
                    console.log(e);
                 }

            });

        };



        function setCancelJobId(JID) {

            $("#cancelJobId").val(JID)
        }
        function modalJobCancel() {
            $("#cancelJobId").val($("#jid").val());
            //cancelJob();
        }
        function cancelJob()
        {
            var jobId = $("#cancelJobId").val();
            $("#cancelJobId").val("");
            $.ajax({
                type: "POST",
                 url: '@Url.Action("CancelJob", "Admin")',
                 data: { JobId: jobId },
                 dataType: "json",

                success: function (message) {
                    if (message == 1) {

                        window.location.reload(true);
                        //alert("Job is canceled Successfully.");
                    }
                    else {
                        //alert("Sorry, Job cannot cancel");
                    }

                 },
                error: function (e, text, string) {
                    //alert("Sorry, Job cannot cancel");
                 }
            });
           
            window.location.reload(true);

        }

        function editJob() {


            //$(".jobEditGroup").removeAttr("readonly");
            //$(".saveButton").removeAttr("hidden");

            $(".allocateBtn").hide();
            $(".jobEditGroup").removeAttr("readonly");
            $(".edit").removeAttr("hidden");
            $(".saveButton").show();
        }

        function onShowModal() {
            alert("ook");
            $(".jobEditGroup").addBack("readonly");
            $(".saveButton").addBack("hidden");
        }

        function allocateJob() {
            $(".DriverDropdown").removeAttr("hidden");
        }

        function DirectAllocateJob(Id) {
            jobInfo(Id);
            $(".DriverDropdown").removeAttr("hidden");

        }



        function allocateJobToDriver() {

            var driverId = $("#drivers").val();

            if ($("#drivers").val() == 0) {
                $("#drivers").addClass("border-danger");
                alert("not selected");
            }
            else {
                //alert("" + $("#drivers").val());

                //var job =
                var txt = $("#jobId").val();

                //var jobID =$("#jobId").html(txt + success.jb.id);
                var jobID = $("#jid").val();

                var pickUpAddress = $("#pickUpAddress").val();
                var dropOffAddress = $("#dropOffAddress").val();
                var distance = $("#distance").val();
                var price = $("#price").val();

                //$("#carType").select(success.CarType
                //var dAndT = "" + success.jb.dateAndTime;


                var time = $("#time").val() + " " + $("#date").val();
                var driverMessage = $("#driverMessage").val();

                var name = $("#name").val();
                var phone = $("#phone").val();
                //alert("" + driverId);
                //alert("ALLOCATE" + jobID + " " + time + " " + phone + " " + distance + " " + price);

                $.ajax({
                    type: "POST",
                    url: '@Url.Action("AllocateJob", "Admin")',
                    data: {

                        Id: jobID,
                        DriverId: driverId,
                        PhoneNo: phone,
                        PName: name,
                        Time: time,
                        DriverMessage: driverMessage,
                        Distance: distance,
                        Price: price
                    },
                    dataType: "json",

                    success: function (success) {

                        //alert("success" + success)

                    },
                    error: function (e, text, string) {
                        //alert(e.message + text + string);
                        console.log(e);
                    }
                });
                location.reload(true);
                window.location.reload(true);
                location.reload(true);
            }

        }





        function setfinshJobId(FJID) {

            $("#finishJobId").val(FJID)

        }

        function finishJob() {
           
            var jobId = $("#finishJobId").val();
           // alert("okkkk" + jobId);
            $.ajax({
                type: "POST",
                 url: '@Url.Action("FinishJob", "Admin")',
                 data: { JobId: jobId },
                 dataType: "json",

                success: function (message) {
                    if (message == 1) {
                      //  alert("Job is Finished Successfully.");
                    }
                    else {
                        alert("Sorry, Job cannot finish");
                    }

                 },
                error: function (e, text, string) {
                    alert("Sorry, Job cannot finish");
                 }
            });
            window.location.reload(true);
            location.reload(true);

        }

    </script>
}
